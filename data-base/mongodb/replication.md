# 复制集

MongoDB 复制集由一组 mongod 实例（进程）组成，包含一个 Primary 节点和多个 Secondary 节点， Mongodb Driver（客户端）的所有数据都写入Primary，Secondary 从 Primary 同步写入的数据，以保持复制集内所有成员存储相同的数据集，提供数据的高可用。

那为什么要设置复制集呢？

- 由于复制集是通过不同服务器上保存来的副本，可保证数据在生产部署的冗余和可靠性，不会因为单点问题而丢失数据
- 可以通过访问不同服务器副本数据来提高数据读取能力，从而提高整个系统的负载能力

## 架构原理

副本集包含**多个数据节点**和**可选的一个仲裁节点**。而在数据节点中：只有一个 **主节点（Primary Node）**，其他节点为 **从节点（Secondary Nodes）**。

各个节点成员通过**心跳机制**进行通信，为主节点与节点的通信的时间超过配置的 electionTimeoutMillis 期间（默认 10 秒）时，符合条件的从节点要求选举将自己指定为新主节点，群集尝试完成新主节点的**选举**并恢复正常操作。

![](../../snapshots/mongodb/mongodb-replication-relationship..png)

**主节点：**副本集只能有一个主节点能够确认写入操作来接收所有写操作，并记录其操作日志中的数据集的所有更改（记录在 oplog 中）。

**oplog：**它保存了修改存储在数据库中的数据的所有操作的 **滚动记录**，MongoDB 在主节点服务器上应用数据库操作，然后在主节点服务器的 oplog 上记录操作，然后从节点成员在异步过程中通过心跳机制从任何其他成员导入 oplog 并应用这些操作，oplog 中的每个操作都是幂等的。所有副本集成员都在 `local.oplog.rs` 集合中包含 oplog 的副本，这允许它们维护数据库的当前状态。

**从节点：** 复制主节点的 oplog 并将 oplog 记录的操作应用于其数据集，如果主节点宕机了，将从符合条件的从节点选举选出新的主节点，。 而且你可以通过配置实现特定的功能，比如：

- 防止从节点成为选举中的主节点Primary，指定节点优先级。
- 阻止应用程序从节点读取数据，从而允许应用程序运行需要与正常流量分离的应用程序，隐藏节点。
- 保留正在运行的“历史”快照，以用于从某些错误中恢复，例如无意中删除的数据库，延迟节点

**仲裁节点：** 仲裁节点不维护数据集。 仲裁节点的目的是通过响应其他副本集节点的心跳和选举请求来维护副本集中的仲裁。 因为它们不存储数据集，所以仲裁节点可以是提供副本集仲裁功能的好方法，其资源成本比具有数据集的全功能副本集成员更便宜。 如果您的副本集具有偶数个成员，请添加仲裁节点以获得主要选举中的大多数投票。而且仲裁节点总是只有1次选举投票，因此允许副本集具有不均匀的投票成员数，而没有复制数据的额外成员的开销。

![](../../snapshots/mongodb/mongodb-replication-heartbeat.png)

**心跳机制（Hearbeat）：** 复制集成员间默认**每两秒**会发送一次心跳信息，如果**十秒**未收到某个节点的心跳，则认为该节点已宕机不可以访问；如果宕机的节点为 Primary，Secondary（前提是可被选为 Primary）会发起新的Primary选举。仲裁员与其他集合成员之间的唯一沟通是：选举期间的投票，心跳和配置数据，而且这些交换未加密。

**数据同步：** 为了维护共享数据集的最新副本，副本的从节点设置同步或复制来自其他节点的数据。 MongoDB 使用两种形式的数据同步：初始化同步新节点同步完整的数据集，以及整个集群节点同步后续数据更改。

其中，初始化同步（Initial Sync）过程：

- 克隆除本地数据库之外的所有数据库。 要进行克隆，mongod会扫描每个源数据库中的每个集合，并将所有数据插入到这些集合的自己的副本中。 初始同步会在为每个集合复制文档时构建所有集合索引。 在早期版本的MongoDB中，在此阶段仅构建_id索引。
- 初始同步在数据复制期间提取新添加的oplog记录。 确保目标成员在本地数据库中有足够的磁盘空间，以便在此数据复制阶段的持续时间内临时存储这些oplog记录。
- 将所有更改应用于数据集。 使用来自源的oplog，mongod更新其数据集以反映副本集的当前状态。 初始同步完成后，成员从STARTUP2转换为SECONDARY。

## 标准复制集架构

标准复制集架构由三台服务器，其中包括三个数据节点(一个主节点、两个从节点)或两个数据节点(一个主节点、一个从节点)和一个仲裁节点两种情况。如下所示：

三个数据节点：

- 一个主节点
- 两个从节点，主节点宕机后，有机会选举成为主节点

![](../../snapshots/mongodb/mongodb-replication-heartbeat.png)

当主库宕机后，两个从库都会进行竞选，其中一个变为主库，当原主库恢复后，作为从库加入当前的复制集群即可。

![](../../snapshots/mongodb/mongodb-election-for-new-primary.png)

两个数据节点以及一个仲裁节点：

- 一个主节点
- 一个从节点，有机会被选举成为主节点
- 一个仲裁节点，只有投票权利

![](../../snapshots/mongodb/mongodb-arbiter.png)

当主节点不可用时，将会选择从节点成为主Primary，主节点恢复后，将其作为从节点加入到现有的复制集群中即可。

![](../../snapshots/mongodb/mongodb-new-primary.jpg)

## 节点类型

### 优先级零型节点

优先级 0 型节点不可以成为成为主节点，也不能触发选举。将从节点配置为优先级为 0 以防止它成为主节点，这在多数据中心部署中特别有用，在许多情况下，您无需将备用数据库设置为优先级 0。但是，在具有不同硬件或地理分布的副本集中，优先级为 0 的备用数据库可确保仅某些成员成为主数据库，这样可以根据实际网络分区的网络质量等实际情况进行配置。

例如，一个数据中心承载主数据中心和辅助数据中心：

![](../../snapshots/mongodb/mongodb-priority-zero-node.png)

第二个数据中心节点优先级为 0 只能是从节点数据库，而数据中心（1）中的节点才能成为主节点数据库。（比如你跨机房 A 和 B 部署了一个复制集，并且想指定 Primary 必须在 A 机房，这时可以将 B 机房的复制集成员 Priority 设置为 0，这样 Primary 就一定会是 A 机房的成员）

### 隐藏型节点

隐藏型（Hidden）节点：

- 隐藏型从节点是维护主数据集的副本，但对客户端应用程序不可见。隐藏型从节点适用于具有与副本集中其他成员不同的使用模式
- 隐藏型从节点必须始终优先为 0 型从节点，因此不能成为主节点。隐藏型从节点可能会在选举中投票。
- 隐藏型从节点将不会收到来自应用程序的请求。我们可以将隐藏型从节点专用于报表节点或是备份节点。

### 延迟型节点

由于延迟型从节点是数据集的**滚动备份**或运行**历史**快照，因此它们可以帮助您从各种认为错误中恢复。例如，延迟节点可以从不成功的应用程序升级和操作员错误（包括丢弃的数据库和集合）中恢复。而且延迟型从节点一定是优先级为 0 的从节点，也是隐藏型从节点。不能是主节点，也不能给客户端查询。

在选择延迟量，请考虑延迟量：

- 必须等于或大于预期的维护窗口的持续时间
- 必须小于 oplog 的容量

### 投票型节点和不可投票节点

复制集节点可以通过配置 votes 字段来决定该节点是否具有投票权：

- 0：不可投票节点（持有副本集数据副本，可接受来自客户端应用程序读取操作）
- 1：投票型节点

另外在副本集最多可包含 50 个成员，但只有 7 个投票成员，因此非投票成员允许副本集具有 7 个以上的成员。并投票成员只有具备以下状态可以进行投票：

- PRIMARY
- SECONDARY
- STARTUP2
- RECOVERING
- ARBITER
- ROLLBACK

**配置：**

```json
{
  "_id": <num>,
  "host": <hostname:port>,
  "arbiterOnly": false,
  "buildIndexes": true,
  "hidden": false,
  "priority": 0,
  "tags": {},
	"slaveDelay": NumberLong(0),
	"votes": 0
}
```

## 复制集选举





写库记录



启动节点



创建复制集





- 候选节点发起选举，每个节点投票给比自己更同步的节点
- 得到超过半数选票的候选节点会当选为主节点
- 复制集中最多可以有 7 个投票节点



触发选举的事件

- 主节点与副节点之间的心跳请求超时
- 复制集初始化
- 新节点加入复制集





## 部署结构

**最大投票成员为数量**

副本集最多可包含 50 个成员，但只有 7 个投票成员。如果副本集已有 7 个投票成员，则其他成员必须是非投票成员。

**部署奇数个成员**

副本集应该确保具有奇数个投票成员，如果您拥有偶数个投票成员，请部署仲裁节点，以便该集合具有奇数个投票成员。仲裁节点不存储数据的副本并且需要更少的资源。因此，您可以在应用程序服务器或其他共享进程上运行仲裁程序。

**容错能力**

副本集的容错是当变为不可用的成员数，并且仍然在副本集中留下足够的节点成员来选择主节点成员。容错是副本集大小的影响， 见下表：

| 选举成员数量 | 选举所需多数票 | 容错 |
| ------------ | -------------- | ---- |
| 3            | 2              | 1    |
| 4            | 3              | 1    |
| 5            | 3              | 2    |
| 6            | 4              | 2    |

因此可以得出，将成员添加为偶数个到副本集并不总是会增加容错能力。但是，在这些情况下，其中将其中一个节点设置成隐藏型和延迟型从节点可以为专用功能提供支持，例如备份或报告。

---

**参考资料：**

- [认识 MongoDB 复制集](https://juejin.im/post/5cdba4a551882538841bca8c)
- [MongoDB 系列：解决面试中可能遇到的 MongoDB 复制集问题](https://juejin.im/post/5d492ab9f265da03ad1437ed)