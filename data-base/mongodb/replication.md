# 复制集

MongoDB 复制集由一组 mongod 实例（进程）组成，包含一个 Primary 节点和多个 Secondary 节点， Mongodb Driver（客户端）的所有数据都写入Primary，Secondary 从 Primary 同步写入的数据，以保持复制集内所有成员存储相同的数据集，提供数据的高可用。

那为什么要设置复制集呢？

- 由于复制集是通过不同服务器上保存来的副本，可保证数据在生产部署的冗余和可靠性，不会因为单点问题而丢失数据
- 可以通过访问不同服务器副本数据来提高数据读取能力，从而提高整个系统的负载能力

## 架构原理

副本集包含**多个数据节点**和**可选的一个仲裁节点**。而在数据节点中：只有一个 **主节点（Primary Node）**，其他节点为 **从节点（Secondary Nodes）**。

各个节点成员通过**心跳机制**进行通信，为主节点与节点的通信的时间超过配置的 electionTimeoutMillis 期间（默认 10 秒）时，符合条件的从节点要求选举将自己指定为新主节点，群集尝试完成新主节点的**选举**并恢复正常操作。

![](../../snapshots/mongodb/mongodb-replication-relationship..png)]

**主节点：**副本集只能有一个主节点能够确认写入操作来接收所有写操作，并记录其操作日志中的数据集的所有更改（记录在 oplog 中）。

**oplog：**它保存了修改存储在数据库中的数据的所有操作的 **滚动记录**，MongoDB 在主节点服务器上应用数据库操作，然后在主节点服务器的 oplog 上记录操作，然后从节点成员在异步过程中通过心跳机制从任何其他成员导入 oplog 并应用这些操作，oplog 中的每个操作都是幂等的。所有副本集成员都在 `local.oplog.rs` 集合中包含 oplog 的副本，这允许它们维护数据库的当前状态。



主节点（写）

- 主节点负责处理所有的写入请求
- 主节点（默认）和副节点都可以处理读取请求

副节点（备份/复制）

- 副节点从主节点（或者符合条件的副节点，同步性更高）处理复制数据





每个节点都会向其他节点发送心跳请求

每隔两秒发送一次，超过 10 秒则请求超时（默认）

复制集中最多可以有 50 个节点







- 高可用性
- 数据安全
- 分流/分工











## 复制集选举





写库记录



启动节点



创建复制集





- 候选节点发起选举，每个节点投票给比自己更同步的节点
- 得到超过半数选票的候选节点会当选为主节点
- 复制集中最多可以有 7 个投票节点



触发选举的事件

- 主节点与副节点之间的心跳请求超时
- 复制集初始化
- 新节点加入复制集



---

**参考资料：**

- [认识 MongoDB 复制集](https://juejin.im/post/5cdba4a551882538841bca8c)
- 