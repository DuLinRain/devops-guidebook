<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/devops-guidebook/umi.css" />
    <script>
      window.routerBase = "/devops-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.9
    </script>
    <title>&#x805A;&#x5408;&#x7BA1;&#x9053;</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/favicon.png&#x27;)" href="/devops-guidebook//">DevOps Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/devops-guidebook//linux">Linux</a><a href="/devops-guidebook//server">服务器</a><a aria-current="page" class="active" href="/devops-guidebook//data-base">数据库</a><a href="/devops-guidebook//deploy">部署</a><a href="/devops-guidebook//version">版本管理</a><a href="/devops-guidebook//devops">DevOps</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/favicon.png&#x27;)" href="/devops-guidebook//"></a><h1>DevOps Guidebook</h1><p>DevOps 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/devops-guidebook//linux">Linux</a></li><li><a href="/devops-guidebook//server">服务器</a></li><li><a aria-current="page" class="active" href="/devops-guidebook//data-base">数据库</a></li><li><a href="/devops-guidebook//deploy">部署</a></li><li><a href="/devops-guidebook//version">版本管理</a></li><li><a href="/devops-guidebook//devops">DevOps</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/devops-guidebook//data-base">数据库</a></li><li><a href="/devops-guidebook//data-base/no-sql">NoSQL</a></li><li><a aria-current="page" class="active" href="/devops-guidebook//data-base/mongodb">MongoDB</a><ul><li><a href="/devops-guidebook//data-base/mongodb/overview"><span>基本概述</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/installment"><span>安裝使用</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/basic-usage"><span>基本操作</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/backup-and-recovery"><span>备份与恢复</span></a></li><li><a aria-current="page" class="active" href="/devops-guidebook//data-base/mongodb/aggregation"><span>聚合管道</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/indexes"><span>数据库索引</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/data-models"><span>数据模型</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/replication"><span>数据库副本集</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/sharding"><span>数据库分片</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/administration"><span>数据库管理</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/security"><span>数据库安全</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/configuration"><span>配置文件</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/command"><span>命令大全</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/mongodb"><span>扩展资料</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/authentication"><span>鉴权</span></a></li><li><a href="/devops-guidebook//data-base/mongodb/shard-key"><span>片键</span></a></li></ul></li><li><a href="/devops-guidebook//data-base/mysql">MySQL</a><ul><li><a href="/devops-guidebook//data-base/mysql/mysql"><span>MySQL</span></a></li><li><a href="/devops-guidebook//data-base/mysql/cluster"><span>集群方案</span></a></li></ul></li><li><a href="/devops-guidebook//data-base/radis">Radis</a></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="聚合框架" data-depth="2" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#聚合框架"><span>聚合框架</span></a></li><li title="聚合表达式" data-depth="2" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#聚合表达式"><span>聚合表达式</span></a></li><li title="字段路径表达式" data-depth="3" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#字段路径表达式"><span>字段路径表达式</span></a></li><li title="系统变量表达式" data-depth="3" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#系统变量表达式"><span>系统变量表达式</span></a></li><li title="常量表达式" data-depth="3" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#常量表达式"><span>常量表达式</span></a></li><li title="表达式操作符" data-depth="3" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#表达式操作符"><span>表达式操作符</span></a></li><li title="聚合管道阶段" data-depth="3" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#聚合管道阶段"><span>聚合管道阶段</span></a></li><li title="配置项" data-depth="3" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#配置项"><span>配置项</span></a></li><li title="聚合操作的优化" data-depth="2" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#聚合操作的优化"><span>聚合操作的优化</span></a></li><li title="顺序优化" data-depth="3" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#顺序优化"><span>顺序优化</span></a></li><li title="合并优化" data-depth="3" class=""><a href="/devops-guidebook//data-base/mongodb/aggregation#合并优化"><span>合并优化</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="聚合管道"><a aria-hidden="true" href="#聚合管道"><span class="icon icon-link"></span></a>聚合管道</h1><p>先介绍管道的概念，在 POSIX 多线程的使用方式中，定义了一种重要的 pipeline 方式，成为 <strong>流水线</strong> 或 <strong>管道</strong>，这种方式使得数据被一组线程顺序执行。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="Input -&gt; ThreadA -&gt; ThreadB -&gt; ThreadC -&gt; Output
" data-status="copy"></button><div class="token-line"><span class="token plain">Input -&gt; ThreadA -&gt; ThreadB -&gt; ThreadC -&gt; Output</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>以面向对象的思想去理解，整个流水线，可以理解为一个数据传输的管道；该管道中的每一个工作线程，可以理解为一个整个流水线的一个工作阶段 stage，这些工作线程之间的合作是一环扣一环的。靠输入口越近的工作线程，是时序较早的工作阶段 stage，它的工作成果会影响下一个工作线程阶段（stage）的工作结果，即下个阶段依赖于上一个阶段的输出，上一个阶段的输出成为本阶段的输入。这也是 pipeline 的一个共有特点。</p><h2 id="聚合框架"><a aria-hidden="true" href="#聚合框架"><span class="icon icon-link"></span></a>聚合框架</h2><p>Mongodb 在  2.2 版本中引入了 <strong>聚合框架</strong>（aggregate framework）的新功能，它是聚合的新框架，其概念类似于数据处理的管道，每个文档经过一个由多个节点组成的管道，每个节点相当于流水线中的一个 stage，有自己的功能（分组、过滤等），文档经过管道处理后，最后输出相应的结果，管道的基本功能有两个：</p><ol><li>对文档进行<strong>过滤</strong>，筛选出合适的文档</li><li>对文档进行<strong>变换</strong>，改变文档的输出形式</li></ol><p>其他的一些功能还包括按照某个指定的字段分组和排序等。而且在每个阶段还可以使用表达式操作符计算平均值和拼接字符串等相关操作。</p><p>管道提供了一个 MapReduce 的替代方案，MapReduce 使用相对来说比较复杂，而管道的拥有固定的接口（操作符表达），使用比较简单，对于大多数的聚合任务管道一般来说是首选方法。</p><p>MongoDB 中的聚合主要用于简单的数据处理（平均值，求和等），并返回计算后的数据结果，类似于 SQL 中的内嵌函数（<code>count()</code> 等）。</p><p>🌰 MongoDB 官网给出了聚合框架的应用实例：</p></div><img src="/devops-guidebook/static/mongodb-aggregation.d9fbbcf4.jpg" width="720"/><div class="markdown"><h2 id="聚合表达式"><a aria-hidden="true" href="#聚合表达式"><span class="icon icon-link"></span></a>聚合表达式</h2><h3 id="字段路径表达式"><a aria-hidden="true" href="#字段路径表达式"><span class="icon icon-link"></span></a>字段路径表达式</h3><table><thead><tr><th>字段路径表达式</th><th>说明</th></tr></thead><tbody><tr><td><code><div id="root"></div>lt;field&gt;</code></td><td>使用 <code>$</code> 来指示字段路径</td></tr><tr><td><code><div id="root"></div>lt;field&gt;.&lt;sub-field&gt;</code></td><td>使用 <code>$</code> 和 <code>.</code> 来指示内嵌文档字段路径</td></tr></tbody></table><h3 id="系统变量表达式"><a aria-hidden="true" href="#系统变量表达式"><span class="icon icon-link"></span></a>系统变量表达式</h3><table><thead><tr><th>系统变量表达式</th><th>说明</th></tr></thead><tbody><tr><td><code>$&lt;variable&gt;</code></td><td>使用 <code>$</code> 来指示系统变量</td></tr><tr><td><code>$CURRENT</code></td><td>指示管道中当前操作的文档</td></tr></tbody></table><h3 id="常量表达式"><a aria-hidden="true" href="#常量表达式"><span class="icon icon-link"></span></a>常量表达式</h3><table><thead><tr><th>常量表达式</th><th>说明</th></tr></thead><tbody><tr><td><code>$literal: &lt;value&gt;</code></td><td>指示常量 <code>&lt;value&gt;</code></td></tr><tr><td><code>$literal: &quot;$name&quot;</code></td><td>指示常量字符串 &quot;<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi mathvariant="normal">&quot;</mi><mo>&lt;</mo><mi>b</mi><mi>r</mi><mi mathvariant="normal">/</mi><mo>&gt;</mo><mtext>这里的</mtext><mi mathvariant="normal">‘</mi></mrow><annotation encoding="application/x-tex">name&quot;&lt;br/&gt;这里的 `</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord">&quot;</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.02778em">r</span><span class="mord">/</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em"></span><span class="mord cjk_fallback">这</span><span class="mord cjk_fallback">里</span><span class="mord cjk_fallback">的</span><span class="mord">‘</span></span></span></span></span>` 被当作常量处理，而不是字段路径表达式</td></tr></tbody></table><h3 id="表达式操作符"><a aria-hidden="true" href="#表达式操作符"><span class="icon icon-link"></span></a>表达式操作符</h3><table><thead><tr><th>常用表达式</th><th>说明</th></tr></thead><tbody><tr><td><code>$sum</code></td><td>计算总和，<code>{<!-- -->$sum: 1<!-- -->}</code> 表示返回总和 x 1 的值，使用 <code>{<!-- --> $sum: &#x27;$指定字段&#x27; <!-- -->}</code> 也能直接获取指定字段的值的总和</td></tr><tr><td><code>$avg</code></td><td>求平均值</td></tr><tr><td><code>$min</code></td><td>求最小值</td></tr><tr><td><code>$max</code></td><td>求最大值</td></tr><tr><td><code>$push</code></td><td>将结果文档中插入值到一个数组中</td></tr><tr><td><code>$first</code></td><td>根据文档的排序获取第一个文档数据</td></tr><tr><td><code>$last</code></td><td>同理，获取最后一个文档数据</td></tr></tbody></table><h3 id="聚合管道阶段"><a aria-hidden="true" href="#聚合管道阶段"><span class="icon icon-link"></span></a>聚合管道阶段</h3><table><thead><tr><th>聚合管道表达式</th><th>说明</th><th>MySQL 操作/函数</th></tr></thead><tbody><tr><td><a href="#project"><code>$project</code></a></td><td>对输入文档进行再次投影</td><td>where</td></tr><tr><td><a href="#match"><code>$match</code></a></td><td>对输入文档进行筛选</td><td>having</td></tr><tr><td><a href="#limit-%E5%92%8C-skip"><code>$limit</code></a></td><td>筛选出管道内前 N 篇文档</td><td>limit</td></tr><tr><td><a href="#limit-%E5%92%8C-skip"><code>$skip</code></a></td><td>跳过管道内前 N 篇文档</td><td></td></tr><tr><td><a href="#skip"><code>$unwind</code></a></td><td>展开输入文档中的数组字段</td><td></td></tr><tr><td><a href="#sort"><code>$sort</code></a></td><td>对输入文档进行排序</td><td>order by</td></tr><tr><td><a href="#lookup"><code>$lookup</code></a></td><td>对输入文档进行查询操作</td><td>join</td></tr><tr><td><a href="#group"><code>$group</code></a></td><td>对输入文档进行分组</td><td>group by</td></tr><tr><td><a href="#out"><code>$out</code></a></td><td>将管道中的文档输出</td><td></td></tr></tbody></table><h4 id="project"><a aria-hidden="true" href="#project"><span class="icon icon-link"></span></a>$project</h4><p><code>$project</code> 管道操作符用于修改流中的文档。</p><p>对文档进行重新投影，主要用于<strong>重命名</strong>、<strong>增加字字段</strong>、<strong>删除字段</strong>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 隐藏文档 class 主键，显示 age 字段值
# 添加新字段 name，值为原文档中字段 info 中的 name 的值
$ db.class.aggregate([
  {
    $project: {
      _id: 0,
      age: 1,
      name: &quot;$info.name&quot;,
    }
  }
])

# 同样地，隐藏文档 class 主键，显示 age 字段值
# 添加新字段 sub，其数据类型为数组，也以对应 subject 的对象键值填充
# 当不存在字段，会使用 null 填充
$ db.class.aggregate([
  {
    $project: {
      _id: 0,
      age: 1,
      sub: [
        &quot;$subject.chinese&quot;,
        &quot;$subject.maths&quot;,
        &quot;$subject.english&quot;
      ]
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 隐藏文档 class 主键，显示 age 字段值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 添加新字段 name，值为原文档中字段 info 中的 name 的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.class.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$project</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _id: </span><span class="token number">0</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      age: </span><span class="token number">1</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      name: </span><span class="token string">&quot;</span><span class="token string variable">$info</span><span class="token string">.name&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 同样地，隐藏文档 class 主键，显示 age 字段值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 添加新字段 sub，其数据类型为数组，也以对应 subject 的对象键值填充</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 当不存在字段，会使用 null 填充</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.class.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$project</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _id: </span><span class="token number">0</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      age: </span><span class="token number">1</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      sub: </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;</span><span class="token string variable">$subject</span><span class="token string">.chinese&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;</span><span class="token string variable">$subject</span><span class="token string">.maths&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;</span><span class="token string variable">$subject</span><span class="token string">.english&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>$project</code> 是很常用的聚合阶段，可以用来灵活地控制输出文档的格式，也可以用来提出不相关的字段，以优化聚合管道操作的性能。</p><h4 id="match"><a aria-hidden="true" href="#match"><span class="icon icon-link"></span></a>$match</h4><p><code>$match</code> 中使用的<strong>文档筛选语法</strong>，和读取文档时的 <code>$match</code> 语法相同。主要用于过滤、筛选符合条件的文档，作为下一阶段的输入。</p><p>⚠️ <strong>注意</strong>：由于 <code>aggregate</code> 管道对于内存的限制，在处理大文件的时候，最好先用 <code>$match</code> 操作符进行筛选，减少内存占用。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 匹配 class 文档字段（嵌套文档） &lt;field&gt; 的字段 &lt;sub-field&gt; 的值为 &lt;value&gt; 的文档
$ db.class.aggregate([
  {
    $match: {
      &quot;&lt;field&gt;.&lt;sub-field&gt;&quot;: &lt;value&gt;
    }
  }
])

$ db.class.aggregate([
  {
    $match: {
      $or: [
        {
          &lt;field1&gt;: {
            &lt;comparasion-operator1&gt;: &lt;value1&gt;,
            &lt;comparasion-operator2&gt;: &lt;value2&gt;
           }
        }, {
          &quot;&lt;field2&gt;.&lt;sub-field2&gt;&quot;: &lt;value3&gt;
        }
      ]
      &quot;&lt;field&gt;.&lt;sub-field&gt;&quot;: &lt;value&gt;
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 匹配 class 文档字段（嵌套文档） &lt;field&gt; 的字段 &lt;sub-field&gt; 的值为 &lt;value&gt; 的文档</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.class.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$match</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&quot;&lt;field&gt;.&lt;sub-field&gt;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.class.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$match</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token variable">$or</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">&lt;</span><span class="token plain">field</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">comparasion-operator</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">comparasion-operator</span><span class="token operator file-descriptor important">2</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">2</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">           </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain">, </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token string">&quot;&lt;field2&gt;.&lt;sub-field2&gt;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">3</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&quot;&lt;field&gt;.&lt;sub-field&gt;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>$match</code> 常常用于剔除或保留某篇文档。应该尽量在聚合管道的开始阶段应用 <code>$match</code>，这样可以减少后续阶段中需要处理的文档数量，优化聚合操作的性能。</p><p>⚠️ <strong>注意事项：</strong></p><ul><li>不能在 <code>$match</code> 操作符中使用 <code>$where</code> 表达式操作符</li><li><code>$match</code> 应该尽可能在管道查询的前置阶段，可以提早过滤文档，减少后续阶段操作文档，加快聚合速度</li><li>如果 <code>$match</code> 出现在最前面的话，可以使用索引来加快查询</li></ul><h4 id="limit-和-skip"><a aria-hidden="true" href="#limit-和-skip"><span class="icon icon-link"></span></a>limit 和 skip</h4><p><code>$limt</code> 和 <code>$skip</code> 通常在一起使用。</p><p><code>$limit</code> 用于限制经过管道的文档的数量。</p><p><code>$skip</code> 用于待操作集合处理前跳过部分的文档。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 筛选 &lt;number&gt; 篇文档
$ db.&lt;collection /&gt;.aggregate([
  { $limit: &lt;number&gt; }
])

# 跳过 &lt;number&gt; 篇文档
$ db.&lt;collection /&gt;.aggregate([
  { $skip: &lt;number&gt; }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 筛选 &lt;number&gt; 篇文档</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$limit</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">number</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 跳过 &lt;number&gt; 篇文档</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$skip</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">number</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="unwind"><a aria-hidden="true" href="#unwind"><span class="icon icon-link"></span></a>$unwind</h4><p>将数组拆分成独立字段。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 如果原文档中对应的 &lt;field&gt; 字段是数组，那么就会将数组中每个元素，生成新的文档，对应的 &lt;field&gt; 为展开的数组成员
# 新生成的文档文档主键都是一致的，区别在于 &lt;field&gt; 的不同
# 如果原文档中对应的 &lt;field&gt; 字段为非数组，那么不会有其他操作，直接保留下来
$ db.&lt;collection /&gt;.aggregate([
  {
    $unwind: {
      path: &quot;<div id="root"></div>lt;field&gt;&quot;
    }
  }
])

# 同上，但是展开后会添加一个新字段 &lt;field-item-index&gt;，为原文档数组中的索引数值
# 如果原文档对应 &lt;field&gt; 不是数组类型，新增的字段默认填充 null
$ db.&lt;collection /&gt;.aggregate([
  {
    $unwind: {
      path: &quot;<div id="root"></div>lt;field&gt;&quot;,
      includArrayIndex: &lt;field-item-index&gt;
    }
  }
])

# 展开数组时保留空数组或不存在数组的文档
$ db.&lt;collection /&gt;.aggregate([
  {
    $unwind: {
      path: &quot;<div id="root"></div>lt;field&gt;&quot;,
      preserveNullAndEmptyArrays: true
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 如果原文档中对应的 &lt;field&gt; 字段是数组，那么就会将数组中每个元素，生成新的文档，对应的 &lt;field&gt; 为展开的数组成员</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 新生成的文档文档主键都是一致的，区别在于 &lt;field&gt; 的不同</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 如果原文档中对应的 &lt;field&gt; 字段为非数组，那么不会有其他操作，直接保留下来</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$unwind</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path: </span><span class="token string">&quot;<div id="root"></div>lt;field&gt;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 同上，但是展开后会添加一个新字段 &lt;field-item-index&gt;，为原文档数组中的索引数值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 如果原文档对应 &lt;field&gt; 不是数组类型，新增的字段默认填充 null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$unwind</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path: </span><span class="token string">&quot;<div id="root"></div>lt;field&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      includArrayIndex: </span><span class="token operator">&lt;</span><span class="token plain">field-item-index</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 展开数组时保留空数组或不存在数组的文档</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$unwind</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path: </span><span class="token string">&quot;<div id="root"></div>lt;field&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      preserveNullAndEmptyArrays: </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="sort"><a aria-hidden="true" href="#sort"><span class="icon icon-link"></span></a>$sort</h4><p>对文档按照指定字段排序，与查询文档 <code>find()</code> 时的 <code>sort</code> 相同。</p><ul><li><code>1</code>：由小到大</li><li><code>-1</code>：由大到小</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 对文档进行排序
$ db.&lt;collection /&gt;.aggregate([
  {
    $sort: {
      &lt;field1&gt;: &lt;sort-number&gt;,
      &quot;&lt;field2&gt;.&lt;sub-field&gt;&quot;: &lt;sort-number&gt;
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 对文档进行排序</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$sort</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">field</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">sort-number</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&quot;&lt;field2&gt;.&lt;sub-field&gt;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">sort-number</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="lookup"><a aria-hidden="true" href="#lookup"><span class="icon icon-link"></span></a>$lookup</h4><h5 id="使用单一字段值进行查询"><a aria-hidden="true" href="#使用单一字段值进行查询"><span class="icon icon-link"></span></a>使用单一字段值进行查询</h5><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$lookup: {
  # 同一数据库中的另一个查询集合（不能跨数据库查询）
  from: &lt;collection to join /&gt;,
  # 管道文档中用来查询的字段
  localField: &lt;field from the input docuement&gt;,
  # 查询集合中的查询字段
  foreignField: &lt;field from the documents of the &quot;from&quot; collection&gt;,
  # 写入管道文档中的查询结果数组字段
  as: &lt;output array field&gt;
}
" data-status="copy"></button><div class="token-line"><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 同一数据库中的另一个查询集合（不能跨数据库查询）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  from: </span><span class="token operator">&lt;</span><span class="token plain">collection to </span><span class="token function">join</span><span class="token plain"> /</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 管道文档中用来查询的字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  localField: </span><span class="token operator">&lt;</span><span class="token plain">field from the input docuement</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 查询集合中的查询字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  foreignField: </span><span class="token operator">&lt;</span><span class="token plain">field from the documents of the </span><span class="token string">&quot;from&quot;</span><span class="token plain"> collection</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 写入管道文档中的查询结果数组字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  as: </span><span class="token operator">&lt;</span><span class="token plain">output array field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>如下面代码所示：</p><p>MongoDB 会先管道查询 <code>&lt;aggregation-collection&gt;</code> 集合（这里我们称为管道集合），同时也会查询另一个集合 <code>&lt;find-collection&gt;</code>（这里我们称为查询集合）。当管道集合文档中的字段 <code>&lt;aggregation-field&gt;</code> 与查询集合文档中的字段 <code>&lt;find-field&gt;</code> 相匹配时，这篇查询集合中的文档就是符合查询条件的文档，那么就会将这篇文档添加到管道集合对应文档的 <code>&lt;new-field&gt;</code> 字段中。而 <code>&lt;new-field&gt;</code> 的内容就根据查询结果而有所不同，</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ db.&lt;aggregation-collection&gt;.aggregate([
  {
    $lookup: {
      from: &quot;&lt;find-collection&gt;&quot;,
      localField: &quot;&lt;aggregation-field&gt;&quot;,
      foreignField: &quot;&lt;find-field&gt;&quot;,
      as: &quot;&lt;new-field&gt;&quot;
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">aggregation-collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      from: </span><span class="token string">&quot;&lt;find-collection&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      localField: </span><span class="token string">&quot;&lt;aggregation-field&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      foreignField: </span><span class="token string">&quot;&lt;find-field&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      as: </span><span class="token string">&quot;&lt;new-field&gt;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>如果管道集合的 <code>&lt;local-field&gt;</code> 字段是个数组字段，查询集合的 <code>&lt;find-field&gt;</code> 字段是字符串字段，<code>&lt;local-field&gt;</code> 多个成员与查询集合中的 <code>&lt;find-field&gt;</code> 相匹配，那么会将查询集合中这几个字段匹配的文档组成数组，赋值到管道集合文档的 <code>&lt;new-field&gt;</code> 新字段中。</li><li>如果都没有对应符合条件的 <code>&lt;find-collection&gt;</code> 文档，那么 <code>&lt;aggregation-collection&gt;</code> 的文档也会保留下来，但是 <code>&lt;new-field&gt;</code> 字段会是空数组</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 如果 localField 是一个数组字段
# 使用 $unwind 将 &lt;aggregation-collection&gt; 的 &lt;aggregation-field&gt; 数组字段展开
$ db.&lt;aggregation-collection&gt;.aggregate([
  {
    $unwind: {
      path: &quot;<div id="root"></div>lt;aggregation-field&gt;&quot;
    }
  },
  {
    $lookup: {
      from: &lt;find-collection&gt;,
      localField: &lt;aggregation-field&gt;,
      foreignField: &lt;find-field&gt;,
      as: &lt;new-field&gt;
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 如果 localField 是一个数组字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 使用 $unwind 将 &lt;aggregation-collection&gt; 的 &lt;aggregation-field&gt; 数组字段展开</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">aggregation-collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$unwind</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path: </span><span class="token string">&quot;<div id="root"></div>lt;aggregation-field&gt;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      from: </span><span class="token operator">&lt;</span><span class="token plain">find-collection</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      localField: </span><span class="token operator">&lt;</span><span class="token plain">aggregation-field</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      foreignField: </span><span class="token operator">&lt;</span><span class="token plain">find-field</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      as: </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>先经过 <code>$unwind</code> 会先把管道集合中  <code>&lt;aggregation-collection&gt;</code> 文档中无法展开的 <code>&lt;aggregation-field&gt;</code> 字段的值的对应文档剔除。</p><h5 id="使用复杂条件进行查询"><a aria-hidden="true" href="#使用复杂条件进行查询"><span class="icon icon-link"></span></a>使用复杂条件进行查询</h5><p><code>let</code> 是在对 <code>pipeline</code> 进行进一步聚合查询时需要用到原管道查询时使用到的文档的字段值时使用的，是用于对原管道查询时所在文档的字段进行再次声明。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$lookup: {
  from: &lt;collection to join /&gt;,
  # 对查询集合中的文档使用聚合阶段进行处理时，如果需要参考管道文档中的字段，则必须使用 let 参数对字段进行声明
  let: { &lt;var_1: &lt;expression&gt;, ..., &lt;var_n&gt;: &lt;expression&gt; },
  # 对查询集合中的文档使用聚合阶段进行查询（针对 from 指定的集合中的文档）
  pipeline: [&lt;pipeline to execute on the collection to join&gt;],
    as: &lt;output array field&gt;
}
" data-status="copy"></button><div class="token-line"><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  from: </span><span class="token operator">&lt;</span><span class="token plain">collection to </span><span class="token function">join</span><span class="token plain"> /</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 对查询集合中的文档使用聚合阶段进行处理时，如果需要参考管道文档中的字段，则必须使用 let 参数对字段进行声明</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  let: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">var_1: </span><span class="token operator">&lt;</span><span class="token plain">expression</span><span class="token operator">&gt;</span><span class="token plain">, </span><span class="token punctuation">..</span><span class="token plain">., </span><span class="token operator">&lt;</span><span class="token plain">var_n</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">expression</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 对查询集合中的文档使用聚合阶段进行查询（针对 from 指定的集合中的文档）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  pipeline: </span><span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token plain">pipeline to execute on the collection to join</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">    as: </span><span class="token operator">&lt;</span><span class="token plain">output array field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>🌰 <strong>示例：</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 对 &lt;find-collection&gt; 以 $match 做筛选做示例
$ db.&lt;aggregation-collection&gt;.aggregate([
  {
    $lookup: {
      from: &lt;find-collection&gt;,
      pipeline: [
        {
          $match: {
            &lt;field&gt;: &lt;value&gt;
          }
        }
      ],
      as: &lt;new-field&gt;
    }
  }
])

# &lt;find-collection-field&gt; 查询集合中文档的字段
# &lt;var-aggregation-field&gt; 是原文档重新声明的字段（相当于一个间接变量）
$ db.&lt;aggregation-collection&gt;.aggregate([
  {
    $lookup: {
      from: &lt;find-collection&gt;,
      let: { &lt;var-aggregation-field&gt;: &quot;<div id="root"></div>lt;aggregation-field&gt;&quot; },
      # pipeline 中所有聚合管道阶段都是应用在查询集合
      pipeline: [
        {
          $match: {
            $expr: {
              $and: [
                { $eq: [ &quot;<div id="root"></div>lt;find-collection-field&gt;&quot;, &lt;value1&gt; ] },
                { $gt: [ &quot;$&lt;var-aggregation-field&gt;&quot;, &lt;value2&gt; ] }
              ]
            }
          }
        }
      ],
      as: &lt;new-field&gt;
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 对 &lt;find-collection&gt; 以 $match 做筛选做示例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">aggregation-collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      from: </span><span class="token operator">&lt;</span><span class="token plain">find-collection</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      pipeline: </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token variable">$match</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">field</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      as: </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># &lt;find-collection-field&gt; 查询集合中文档的字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># &lt;var-aggregation-field&gt; 是原文档重新声明的字段（相当于一个间接变量）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">aggregation-collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      from: </span><span class="token operator">&lt;</span><span class="token plain">find-collection</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      let: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">var-aggregation-field</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token string">&quot;<div id="root"></div>lt;aggregation-field&gt;&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># pipeline 中所有聚合管道阶段都是应用在查询集合</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      pipeline: </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token variable">$match</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token variable">$expr</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token variable">$and</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$eq</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;<div id="root"></div>lt;find-collection-field&gt;&quot;</span><span class="token plain">, </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$gt</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$</span><span class="token string">&lt;var-aggregation-field&gt;&quot;</span><span class="token plain">, </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">2</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      as: </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h4 id="group"><a aria-hidden="true" href="#group"><span class="icon icon-link"></span></a>$group</h4><p>使用 <code>$group</code> 操作符必须指定 <code>_id</code> 域，同时也可以包含一些算术类型的表达式操作符。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$group: {
  # 定义分组规则
  _id: &lt;expression&gt;,
  # 可以使用聚合操作符来定义新字段
  &lt;field1&gt;: { &lt;accumulator1&gt;: &lt;expression1&gt; },
  ...
}
" data-status="copy"></button><div class="token-line"><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 定义分组规则</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _id: </span><span class="token operator">&lt;</span><span class="token plain">expression</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 可以使用聚合操作符来定义新字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token operator">&lt;</span><span class="token plain">field</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">accumulator</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">expression</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">..</span><span class="token plain">.</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>🌰 <strong>示例：</strong></p><p>通过管道集合的 <code>&lt;collection-field&gt;</code> 字段对数据进行分组。</p><p>不实用聚合操作符的情况下，<code>$group</code> 可以返回管道文档中某一字段的所有（不重复的）值。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 基本使用方法
$ db.&lt;collection /&gt;.aggregate([
  {
    $group: {
      &lt;new-field&gt;: &quot;<div id="root"></div>lt;collection-field /&gt;&quot;
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 基本使用方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token string">&quot;<div id="root"></div>lt;collection-field /&gt;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>下面以实际例子演示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 高级用法，使用聚合操作符计算分组聚合值
$ db.&lt;collection /&gt;.aggregate([
  {
    $group: {
      # 赋值为 null 时，不会分组，所有管道文档分为一组
      _id: &quot;$currency&quot;,
      # 每篇文档的 qty 字段求和结果，赋值 totalQty 新字段
      totalQty: { $sum: &quot;$qty&quot; },
      # 每篇文档的 price 和 qty 的乘积的求和结果
      totalNotional: { $sum: { $multiply: [ &quot;$price&quot;, &quot;$qty&quot; ] } },
      # 每篇文档的 price 字段求得平均数
      avgPrice: { $avg: &quot;$price&quot; },
      # 每篇文档 +1，多少篇就加多少次，集合文档的总数
      count: { $sum: 1 },
      # 找到分组中某个表达式中最大的值
      maxNotional: { $max: { $multiply: [ &quot;$price&quot;, &quot;$qty&quot; ] } },
      #找到分组中某个表达式中最小的值
      minNotional: { $min: { $multiply: [ &quot;$price&quot;, &quot;$qty&quot; ] } },
    }
  }
])
" data-status="copy"></button><div class="token-line"><span class="token comment"># 高级用法，使用聚合操作符计算分组聚合值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 赋值为 null 时，不会分组，所有管道文档分为一组</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _id: </span><span class="token string">&quot;</span><span class="token string variable">$currency</span><span class="token string">&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 每篇文档的 qty 字段求和结果，赋值 totalQty 新字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      totalQty: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$sum</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$qty</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 每篇文档的 price 和 qty 的乘积的求和结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      totalNotional: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$sum</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$multiply</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$price</span><span class="token string">&quot;</span><span class="token plain">, </span><span class="token string">&quot;</span><span class="token string variable">$qty</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 每篇文档的 price 字段求得平均数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      avgPrice: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$avg</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$price</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 每篇文档 +1，多少篇就加多少次，集合文档的总数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      count: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$sum</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 找到分组中某个表达式中最大的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      maxNotional: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$max</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$multiply</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$price</span><span class="token string">&quot;</span><span class="token plain">, </span><span class="token string">&quot;</span><span class="token string variable">$qty</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">#找到分组中某个表达式中最小的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      minNotional: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$min</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$multiply</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$price</span><span class="token string">&quot;</span><span class="token plain">, </span><span class="token string">&quot;</span><span class="token string variable">$qty</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>⚠️ <strong>注意事项：</strong></p><ul><li><code>$group</code> 的输出是无序的</li><li><code>$group</code> 操作目前是在内存中进行的，所以不能用它来对大量个数的文档进行分类</li><li>必须指定 <code>_id</code> 域</li></ul><h4 id="out"><a aria-hidden="true" href="#out"><span class="icon icon-link"></span></a>$out</h4><p>创建指定副本集合</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ db.&lt;collection /&gt;.aggregate([
  {
    $group: {
      _id: &quot;<div id="root"></div>lt;field1&gt;&quot;,
      # &lt;field2&gt; 是数组字段
      &lt;new-field&gt;: { $push: &quot;<div id="root"></div>lt;field2&gt;&quot; }
    }
  },
  {
    # 副本集合名称
    $out: &quot;output&quot;
  }
])
" data-status="copy"></button><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection /</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _id: </span><span class="token string">&quot;<div id="root"></div>lt;field1&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># &lt;field2&gt; 是数组字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$push</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;<div id="root"></div>lt;field2&gt;&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 副本集合名称</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$out</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;output&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>🌰 <strong>实例：</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 已有集合
{ &quot;_id&quot; : 8751, &quot;title&quot; : &quot;The Banquet&quot;, &quot;author&quot; : &quot;Dante&quot;, &quot;copies&quot; : 2 }
{ &quot;_id&quot; : 8752, &quot;title&quot; : &quot;Divine Comedy&quot;, &quot;author&quot; : &quot;Dante&quot;, &quot;copies&quot; : 1 }
{ &quot;_id&quot; : 8645, &quot;title&quot; : &quot;Eclogues&quot;, &quot;author&quot; : &quot;Dante&quot;, &quot;copies&quot; : 2 }
{ &quot;_id&quot; : 7000, &quot;title&quot; : &quot;The Odyssey&quot;, &quot;author&quot; : &quot;Homer&quot;, &quot;copies&quot; : 10 }
{ &quot;_id&quot; : 7020, &quot;title&quot; : &quot;Iliad&quot;, &quot;author&quot; : &quot;Homer&quot;, &quot;copies&quot; : 10 }

# 按照 author 分组，然后 out 一个新集合 authors
$ db.books.aggregate([
  { $group: { _id: &quot;$author&quot;, books: { $push: &quot;$title&quot; } } },
  { $out: &quot;authors&quot; }
])

# 查询结果
 { &quot;_id&quot; : &quot;Homer&quot;, &quot;books&quot; : [ &quot;The Odyssey&quot;, &quot;Iliad&quot; ] }
 { &quot;_id&quot; : &quot;Dante&quot;, &quot;books&quot; : [ &quot;The Banquet&quot;, &quot;Divine Comedy&quot;, &quot;Eclogues&quot; ] }
" data-status="copy"></button><div class="token-line"><span class="token comment"># 已有集合</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">8751</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;The Banquet&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Dante&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">8752</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Divine Comedy&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Dante&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">8645</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Eclogues&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Dante&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">7000</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;The Odyssey&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Homer&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">7020</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Iliad&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Homer&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 按照 author 分组，然后 out 一个新集合 authors</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.books.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> _id: </span><span class="token string">&quot;</span><span class="token string variable">$author</span><span class="token string">&quot;</span><span class="token plain">, books: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$push</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$title</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$out</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;authors&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 查询结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Homer&quot;</span><span class="token plain">, </span><span class="token string">&quot;books&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;The Odyssey&quot;</span><span class="token plain">, </span><span class="token string">&quot;Iliad&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Dante&quot;</span><span class="token plain">, </span><span class="token string">&quot;books&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;The Banquet&quot;</span><span class="token plain">, </span><span class="token string">&quot;Divine Comedy&quot;</span><span class="token plain">, </span><span class="token string">&quot;Eclogues&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="配置项"><a aria-hidden="true" href="#配置项"><span class="icon icon-link"></span></a>配置项</h3><p>每个聚合管道阶段使用的内存不能超过 100MB。</p><p>如果数据量较大，为了防止聚合管道阶段超出内存上限并且抛出错误，可以启用 <code>allowDiskUse</code> 选项。</p><p><code>allowDishUse</code> 启用之后，聚合阶段可以再内存容量不足时，将操作数据写入临时文件中。</p><p>临时文件会被写入 <code>dbPath</code> 下的 <code>_tmp</code> 文件夹，<code>dbPath</code> 的默认值为 <code>/data/db</code>。</p><h2 id="聚合操作的优化"><a aria-hidden="true" href="#聚合操作的优化"><span class="icon icon-link"></span></a>聚合操作的优化</h2><h3 id="顺序优化"><a aria-hidden="true" href="#顺序优化"><span class="icon icon-link"></span></a>顺序优化</h3><h4 id="project--match"><a aria-hidden="true" href="#project--match"><span class="icon icon-link"></span></a><code>$project</code> + <code>$match</code></h4><p>既需要使用 <code>$project</code>，也需要 <code>$match</code> 阶段，MongoDB 在运行聚合管道代码时，尽量把 <code>$match</code> 阶段设置在 <code>$project</code> 阶段之前运行。因为 <code>$match</code> 是对文档进行筛选，所以 <code>$match</code> 阶段很有可能减少文档数量，那么如果我们要尽量减少操作量，那么就需要尽可能早地阶段减少文档进入后续的阶段。</p><h4 id="sort--match"><a aria-hidden="true" href="#sort--match"><span class="icon icon-link"></span></a><code>$sort</code> + <code>$match</code></h4><p>同理，把 <code>$match</code> 提前到 <code>$sort</code> 阶段前，能有效优化。</p><h4 id="project--skip"><a aria-hidden="true" href="#project--skip"><span class="icon icon-link"></span></a><code>$project</code> + <code>$skip</code></h4><p><code>$skip</code> 阶段在 <code>$project</code> 阶段之前运行。</p><h3 id="合并优化"><a aria-hidden="true" href="#合并优化"><span class="icon icon-link"></span></a>合并优化</h3><h4 id="sort--limit"><a aria-hidden="true" href="#sort--limit"><span class="icon icon-link"></span></a><code>$sort</code> + <code>$limit</code></h4><p> 如果两者之间没有夹杂着改变文档数量的聚合阶段，<code>$sort</code> 和 <code>$limit</code> 阶段可以合并。</p><p>同类型的，如下组合也可以进行优化：</p><ul><li><code>$limit</code> + <code>$limit</code></li><li><code>$skip</code> + <code>$skip</code></li><li><code>$match</code> + <code>$match</code></li></ul><p>连续的 <code>$limit</code>、<code>$skip</code> 或 <code>$skip</code> 阶段排列在一起时，可以合并为一个阶段。</p><h4 id="lookup-和-unwind"><a aria-hidden="true" href="#lookup-和-unwind"><span class="icon icon-link"></span></a><code>$lookup</code> 和 <code>$unwind</code></h4><p>连续排列在一起的 <code>$lookup</code> 和 <code>$unwind</code> 阶段，如果 <code>$unwind</code> 应用在 <code>$lookup</code> 阶段创建的 <code>as</code> 字段上，则两者可以合并。</p><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://juejin.im/post/5ba8acb9e51d45395d4ee4d1" target="_blank" rel="noopener noreferrer">MongoDB 聚合管道<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><ul><li><a href="https://www.cnblogs.com/clschen/p/5523897.html" target="_blank" rel="noopener noreferrer">MongoDB 北大绿卡之安全建议<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><ul><li><p><a href="https://t-baby.gitbooks.io/mongodb-plugin/content/ju_he_yun_suan.html" target="_blank" rel="noopener noreferrer">聚合运算<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li><li><p><a href="https://laixiazheteng.com/article/page/id/Bj7qgmJ3CJUE" target="_blank" rel="noopener noreferrer">MongoDB 常用语句<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li><li><p><a href="https://blog.csdn.net/congcong68/article/details/51620040" target="_blank" rel="noopener noreferrer">学习 MongoDB 聚合 Aggregation Pipeline 基础篇<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul><p><a href="https://segmentfault.com/a/1190000020685264?utm_source=tag-newest" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000020685264?utm_source=tag-newest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook/edit/master/docs/data-base/mongodb/aggregation.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">7/11/2020, 7:44:42 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/devops-guidebook/umi.js"></script>
    <script src="/devops-guidebook/docs__data-base__mongodb__aggregation.md.js"></script>
  </body>
</html>
